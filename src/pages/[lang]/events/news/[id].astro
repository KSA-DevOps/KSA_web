---
import BaseLayout from "@layout/BaseLayout.astro";
import { getCollection } from "astro:content";
import { getTranslation } from "@utils/i18n";

// URL íŒŒë¼ë¯¸í„°ì—ì„œ ì–¸ì–´ì™€ ID ì¶”ì¶œ
const { lang, id } = Astro.params;
const currentLang: 'ko' | 'en' = (lang === 'ko' || lang === 'en') ? lang : 'ko';

// ëª¨ë“  ì†Œì‹ ê°€ì ¸ì˜¤ê¸°
const allNews = await getCollection('news');
const news = allNews.find(item => item.id === id);

// ì†Œì‹ì´ ì—†ìœ¼ë©´ 404
if (!news) {
  return Astro.redirect('/404');
}

// ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ ë§¤í•‘
const categoryColors = {
  dormitory: "bg-blue-500",
  membership: "bg-green-500", 
  announcement: "bg-red-500",
  academic: "bg-purple-500",
  events: "bg-orange-500",
  culture: "bg-pink-500"
};

// ì¹´í…Œê³ ë¦¬ë³„ ì´ë¦„ ë§¤í•‘
const categoryNames = {
  dormitory: currentLang === 'ko' ? "ê¸°ìˆ™ì‚¬" : "Dormitory",
  membership: currentLang === 'ko' ? "íšŒì›" : "Membership",
  announcement: currentLang === 'ko' ? "ê³µì§€" : "Announcement",
  academic: currentLang === 'ko' ? "í•™ì—…" : "Academic",
  events: currentLang === 'ko' ? "í–‰ì‚¬" : "Events",
  culture: currentLang === 'ko' ? "ë¬¸í™”" : "Culture"
};

// ê´€ë ¨ ì†Œì‹ ê°€ì ¸ì˜¤ê¸° (ê°™ì€ ì¹´í…Œê³ ë¦¬, ìµœëŒ€ 3ê°œ)
const relatedNews = allNews
  .filter(item => item.id !== id && item.data.category === news.data.category)
  .slice(0, 3);

// ëª©ì°¨ ìƒì„±ì„ ìœ„í•œ ì„¹ì…˜ ì •ì˜
const sections = (() => {
  switch (news.data.category) {
    case 'dormitory':
      return [
        { id: 'application-period', title: currentLang === 'ko' ? 'ì‹ ì²­ ê¸°ê°„' : 'Application Period' },
        { id: 'eligibility', title: currentLang === 'ko' ? 'ì‹ ì²­ ìê²©' : 'Eligibility' },
        { id: 'dormitory-types', title: currentLang === 'ko' ? 'ê¸°ìˆ™ì‚¬ ì¢…ë¥˜' : 'Dormitory Types' },
        { id: 'contact', title: currentLang === 'ko' ? 'ë¬¸ì˜ì²˜' : 'Contact Information' }
      ];
    case 'membership':
      return [
        { id: 'registration-period', title: currentLang === 'ko' ? 'ë“±ë¡ ê¸°ê°„' : 'Registration Period' },
        { id: 'benefits', title: currentLang === 'ko' ? 'ë“±ë¡ í˜œíƒ' : 'Registration Benefits' },
        { id: 'fees', title: currentLang === 'ko' ? 'ë“±ë¡ë¹„' : 'Registration Fees' },
        { id: 'contact', title: currentLang === 'ko' ? 'ë¬¸ì˜ì²˜' : 'Contact Information' }
      ];
    case 'announcement':
      return [
        { id: 'semester-schedule', title: currentLang === 'ko' ? 'í•™ê¸° ì¼ì •' : 'Semester Schedule' },
        { id: 'preparation', title: currentLang === 'ko' ? 'í•„ìˆ˜ ì¤€ë¹„ì‚¬í•­' : 'Required Preparations' },
        { id: 'contact', title: currentLang === 'ko' ? 'ë¬¸ì˜ì²˜' : 'Contact Information' }
      ];
    default:
      return [
        { id: 'contact', title: currentLang === 'ko' ? 'ë¬¸ì˜ì²˜' : 'Contact Information' }
      ];
  }
})();
---

<BaseLayout lang={currentLang}>
  <div class="min-h-screen bg-gradient-to-br from-teal-50 to-blue-50">
    <!-- Hero Section -->
    <section class="relative py-20">
      <div class="container mx-auto px-4 text-center pt-header">
        <div class="max-w-4xl mx-auto">
          <div class="flex items-center justify-center mb-6">
            <span class="text-4xl mr-4">{news.data.icon}</span>
            <span class={`inline-block px-4 py-2 rounded-full text-sm font-medium text-white ${categoryColors[news.data.category as keyof typeof categoryColors]}`}>
              {categoryNames[news.data.category as keyof typeof categoryNames]}
            </span>
          </div>
          <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-6">
            {news.data.title}
          </h1>
          <p class="text-xl text-gray-600 mb-4">
            {news.data.description}
          </p>
          <p class="text-gray-500">
            {news.data.date.toLocaleDateString(currentLang === 'ko' ? 'ko-KR' : 'en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </p>
        </div>
      </div>
    </section>

    <!-- Content Section -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <div class="grid gap-8 md:grid-cols-4 lg:gap-12 max-w-6xl mx-auto">
          {/* Table of Contents */}
          {sections.length > 0 && (
            <div class="relative mt-10 rounded-lg border border-slate-300 border-dashed p-5 md:mt-0 md:border-none md:p-0 md:pb-24">
              <nav class="sticky top-10 md:top-32">
                <small class="font-semibold uppercase text-gray-600">
                  {currentLang === 'ko' ? 'ëª©ì°¨' : 'On this page'}
                </small>
                <ul class="mt-2 space-y-2">
                  {sections.map((section) => (
                    <li>
                      <a
                        href={`#${section.id}`}
                        class="block text-slate-400 transition-colors duration-200 hover:text-slate-600"
                        data-toc-link
                      >
                        {section.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            </div>
          )}

          {/* Main Content */}
          <div class="mx-auto md:col-span-2 md:col-start-2 md:pt-8">
            <article class="prose prose-lg max-w-none">
              <div class="markdown-content">
                <p class="text-gray-600 leading-relaxed mb-8">
                  {news.data.description}
                </p>
              
              {news.data.category === 'dormitory' && (
                <div class="space-y-6">
                  <h2 id="application-period" class="text-2xl font-bold text-gray-800">ì‹ ì²­ ê¸°ê°„</h2>
                  <ul class="list-disc list-inside space-y-2 text-gray-600">
                    <li><strong>1ì°¨ ì‹ ì²­</strong>: 2025ë…„ 1ì›” 15ì¼ ~ 1ì›” 25ì¼</li>
                    <li><strong>2ì°¨ ì‹ ì²­</strong>: 2025ë…„ 1ì›” 26ì¼ ~ 2ì›” 5ì¼</li>
                    <li><strong>ê²°ê³¼ ë°œí‘œ</strong>: 2025ë…„ 2ì›” 10ì¼</li>
                  </ul>
                  
                  <h2 id="eligibility" class="text-2xl font-bold text-gray-800">ì‹ ì²­ ìê²©</h2>
                  <ul class="list-disc list-inside space-y-2 text-gray-600">
                    <li>HKUST ì¬í•™ìƒ</li>
                    <li>KSA ì •íšŒì›</li>
                    <li>ì´ì „ í•™ê¸° ì„±ì  í‰ì  2.5 ì´ìƒ</li>
                  </ul>
                  
                  <h2 id="dormitory-types" class="text-2xl font-bold text-gray-800">ê¸°ìˆ™ì‚¬ ì¢…ë¥˜</h2>
                  <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                      <h3 class="font-semibold text-gray-800">í™€ 1 (Hall 1)</h3>
                      <p class="text-sm text-gray-600">ìœ„ì¹˜: ìº í¼ìŠ¤ ì¤‘ì•™</p>
                      <p class="text-sm text-gray-600">ë°© íƒ€ì…: 2ì¸ì‹¤, 3ì¸ì‹¤</p>
                      <p class="text-sm text-gray-600">ì›”ì„¸: HK$ 3,500 ~ 4,200</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                      <h3 class="font-semibold text-gray-800">í™€ 2 (Hall 2)</h3>
                      <p class="text-sm text-gray-600">ìœ„ì¹˜: ìº í¼ìŠ¤ ë™ìª½</p>
                      <p class="text-sm text-gray-600">ë°© íƒ€ì…: 1ì¸ì‹¤, 2ì¸ì‹¤</p>
                      <p class="text-sm text-gray-600">ì›”ì„¸: HK$ 4,500 ~ 5,200</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                      <h3 class="font-semibold text-gray-800">í™€ 3 (Hall 3)</h3>
                      <p class="text-sm text-gray-600">ìœ„ì¹˜: ìº í¼ìŠ¤ ì„œìª½</p>
                      <p class="text-sm text-gray-600">ë°© íƒ€ì…: 2ì¸ì‹¤, 4ì¸ì‹¤</p>
                      <p class="text-sm text-gray-600">ì›”ì„¸: HK$ 3,200 ~ 3,800</p>
                    </div>
                  </div>
                </div>
              )}
              
              {news.data.category === 'membership' && (
                <div class="space-y-6">
                  <h2 id="registration-period" class="text-2xl font-bold text-gray-800">ë“±ë¡ ê¸°ê°„</h2>
                  <ul class="list-disc list-inside space-y-2 text-gray-600">
                    <li><strong>ì¡°ê¸° ë“±ë¡</strong>: 2025ë…„ 1ì›” 10ì¼ ~ 1ì›” 20ì¼ (í• ì¸ í˜œíƒ)</li>
                    <li><strong>ì¼ë°˜ ë“±ë¡</strong>: 2025ë…„ 1ì›” 21ì¼ ~ 2ì›” 10ì¼</li>
                    <li><strong>ì¶”ê°€ ë“±ë¡</strong>: 2025ë…„ 2ì›” 11ì¼ ~ 3ì›” 31ì¼</li>
                  </ul>
                  
                  <h2 id="benefits" class="text-2xl font-bold text-gray-800">ë“±ë¡ í˜œíƒ</h2>
                  <div class="grid md:grid-cols-2 gap-6">
                    <div>
                      <h3 class="text-lg font-semibold text-gray-800 mb-3">ê¸°ë³¸ í˜œíƒ</h3>
                      <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li>í•œêµ­ ë¬¸í™” ì²´í—˜ í”„ë¡œê·¸ë¨ ì°¸ê°€ ìê²©</li>
                        <li>ë„¤íŠ¸ì›Œí‚¹ ì´ë²¤íŠ¸ ì°¸ê°€ ìê²©</li>
                        <li>í•™ì—… ë©˜í† ë§ ì„œë¹„ìŠ¤ ì´ìš©</li>
                        <li>í•œêµ­ì–´ ìŠ¤í„°ë”” ê·¸ë£¹ ì°¸ê°€</li>
                        <li>KSA ë‰´ìŠ¤ë ˆí„° êµ¬ë…</li>
                      </ul>
                    </div>
                    <div>
                      <h3 class="text-lg font-semibold text-gray-800 mb-3">ì¶”ê°€ í˜œíƒ</h3>
                      <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li>ê¸°ìˆ™ì‚¬ ì‹ ì²­ ìš°ì„ ê¶Œ</li>
                        <li>ì¸í„´ì‹­ ì •ë³´ ìš°ì„  ì œê³µ</li>
                        <li>ì¡¸ì—…ìƒ ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼</li>
                        <li>í•œêµ­ ê¸°ì—… ë°©ë¬¸ ê¸°íšŒ</li>
                        <li>ë¬¸í™” ì¶•ì œ ë¬´ë£Œ ì°¸ê°€</li>
                      </ul>
                    </div>
                  </div>
                  
                  <h2 id="fees" class="text-2xl font-bold text-gray-800">ë“±ë¡ë¹„</h2>
                  <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200">
                      <thead>
                        <tr class="bg-gray-50">
                          <th class="px-4 py-2 border">êµ¬ë¶„</th>
                          <th class="px-4 py-2 border">ì¡°ê¸° ë“±ë¡</th>
                          <th class="px-4 py-2 border">ì¼ë°˜ ë“±ë¡</th>
                          <th class="px-4 py-2 border">ì¶”ê°€ ë“±ë¡</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td class="px-4 py-2 border">ì‹ ì…ìƒ</td>
                          <td class="px-4 py-2 border">HK$ 100</td>
                          <td class="px-4 py-2 border">HK$ 150</td>
                          <td class="px-4 py-2 border">HK$ 200</td>
                        </tr>
                        <tr>
                          <td class="px-4 py-2 border">ì¬í•™ìƒ</td>
                          <td class="px-4 py-2 border">HK$ 80</td>
                          <td class="px-4 py-2 border">HK$ 120</td>
                          <td class="px-4 py-2 border">HK$ 150</td>
                        </tr>
                        <tr>
                          <td class="px-4 py-2 border">ëŒ€í•™ì›ìƒ</td>
                          <td class="px-4 py-2 border">HK$ 120</td>
                          <td class="px-4 py-2 border">HK$ 180</td>
                          <td class="px-4 py-2 border">HK$ 220</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
              
              {news.data.category === 'announcement' && (
                <div class="space-y-6">
                  <h2 id="semester-schedule" class="text-2xl font-bold text-gray-800">í•™ê¸° ì¼ì •</h2>
                  <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">1í•™ê¸° (Spring 2025)</h3>
                    <ul class="space-y-2 text-gray-600">
                      <li><strong>ìˆ˜ì—… ì‹œì‘</strong>: 2025ë…„ 2ì›” 3ì¼ (ì›”ìš”ì¼)</li>
                      <li><strong>ìˆ˜ê°•ì‹ ì²­ ê¸°ê°„</strong>: 2025ë…„ 1ì›” 20ì¼ ~ 1ì›” 31ì¼</li>
                      <li><strong>ìˆ˜ê°•ì‹ ì²­ ë³€ê²½</strong>: 2025ë…„ 2ì›” 3ì¼ ~ 2ì›” 14ì¼</li>
                      <li><strong>ì¤‘ê°„ê³ ì‚¬</strong>: 2025ë…„ 3ì›” 17ì¼ ~ 3ì›” 28ì¼</li>
                      <li><strong>ê¸°ë§ê³ ì‚¬</strong>: 2025ë…„ 5ì›” 12ì¼ ~ 5ì›” 23ì¼</li>
                      <li><strong>í•™ê¸° ì¢…ë£Œ</strong>: 2025ë…„ 5ì›” 30ì¼</li>
                    </ul>
                  </div>
                  
                  <h2 id="preparation" class="text-2xl font-bold text-gray-800">í•„ìˆ˜ ì¤€ë¹„ì‚¬í•­</h2>
                  <div class="grid md:grid-cols-2 gap-6">
                    <div>
                      <h3 class="text-lg font-semibold text-gray-800 mb-3">ìˆ˜ê°•ì‹ ì²­</h3>
                      <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li>í¬í„¸ ì ‘ì†: https://portal.ust.hk</li>
                        <li>í•„ìˆ˜ ê³¼ëª© í™•ì¸</li>
                        <li>ì„ ìˆ˜ê³¼ëª© ì²´í¬</li>
                        <li>ì‹œê°„í‘œ í™•ì¸</li>
                      </ul>
                    </div>
                    <div>
                      <h3 class="text-lg font-semibold text-gray-800 mb-3">í•™ìƒì¦</h3>
                      <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li>ì‹ ê·œ í•™ìƒ: í•™ìƒì¦ ë°œê¸‰ ì‹ ì²­</li>
                        <li>ê¸°ì¡´ í•™ìƒ: ìœ íš¨ê¸°ê°„ í™•ì¸</li>
                        <li>ë¶„ì‹¤ ì‹œ: ì¦‰ì‹œ ì¬ë°œê¸‰ ì‹ ì²­</li>
                      </ul>
                    </div>
                  </div>
                </div>
              )}
              
              <h2 id="contact" class="text-2xl font-bold text-gray-800 mt-8 mb-4">
                {currentLang === 'ko' ? 'ë¬¸ì˜ì²˜' : 'Contact Information'}
              </h2>
              <div class="bg-gray-50 p-6 rounded-lg">
                <ul class="space-y-2 text-gray-600">
                  <li>ğŸ“ <strong>ì „í™”</strong>: +852 2358-9999</li>
                  <li>ğŸ“§ <strong>ì´ë©”ì¼</strong>: info@ksa.ust.hk</li>
                  <li>ğŸ“ <strong>ìœ„ì¹˜</strong>: Academic Building 1ì¸µ</li>
                  <li>ğŸ•’ <strong>ìš´ì˜ì‹œê°„</strong>: í‰ì¼ 10:00-18:00</li>
                </ul>
              </div>
            </div>
          </article>
        </div>
      </div>
    </section>

    <!-- Related News Section -->
    {relatedNews.length > 0 && (
      <section class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
          <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-12 text-center">
              {currentLang === 'ko' ? 'ê´€ë ¨ ì†Œì‹' : 'Related News'}
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                             {relatedNews.map((item) => (
                 <a href={`/${currentLang}/events/news/${item.id}`} class="group">
                  <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <span class="text-2xl mr-3">{item.data.icon}</span>
                        <div>
                          <h3 class="text-lg font-semibold text-gray-800 mb-1 group-hover:text-teal-600 transition-colors">
                            {item.data.title}
                          </h3>
                          <p class="text-sm text-gray-500">
                            {item.data.date.toLocaleDateString(currentLang === 'ko' ? 'ko-KR' : 'en-US', {
                              year: 'numeric',
                              month: 'short',
                              day: 'numeric'
                            })}
                          </p>
                        </div>
                      </div>
                      <p class="text-gray-600 mb-4 line-clamp-3">{item.data.description}</p>
                      <div class="flex justify-between items-center">
                        <span class={`inline-block px-3 py-1 rounded-full text-xs font-medium text-white ${categoryColors[item.data.category as keyof typeof categoryColors]}`}>
                          {categoryNames[item.data.category as keyof typeof categoryNames]}
                        </span>
                        <span class="text-teal-600 group-hover:text-teal-800 text-sm font-medium">
                          {currentLang === 'ko' ? 'ìì„¸íˆ ë³´ê¸°' : 'Read More'}
                        </span>
                      </div>
                    </div>
                  </div>
                </a>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Back to News Button -->
    <section class="py-8 bg-white">
      <div class="container mx-auto px-4">
        <div class="text-center">
          <a 
            href={`/${currentLang}/events/news`}
            class="inline-flex items-center px-6 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors"
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            {currentLang === 'ko' ? 'ì†Œì‹ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°' : 'Back to News'}
          </a>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Initializes the Table of Contents (TOC) by highlighting the active section
    // as the user scrolls. Uses IntersectionObserver for performance optimization.
    let intersectionObserver: IntersectionObserver | null = null;

    function safeInitTOC() {
      if ("requestIdleCallback" in window) {
        requestIdleCallback(initTOC);
      } else {
        setTimeout(initTOC, 200);
      }
    }

    function initTOC() {
      const tocLinks = document.querySelectorAll("[data-toc-link]");
      const sections = document.querySelectorAll("h2[id]");

      if (!tocLinks.length || !sections.length) return;

      tocLinks.forEach((link) =>
        link.classList.remove("text-slate-600", "font-medium"),
      );

      intersectionObserver = new IntersectionObserver(
        (entries) => {
          let activeSection = null;

          entries.forEach((entry) => {
            if (entry.target instanceof HTMLElement && entry.isIntersecting) {
              activeSection = entry.target;
            }
          });

          if (activeSection) {
            const sectionId = (activeSection as HTMLElement).getAttribute("id");
            if (sectionId) {
              document
                .querySelector(`[data-toc-link][href="#${sectionId}"]`)
                ?.classList.add("text-slate-600", "font-medium");
            }
          }
        },
        {
          threshold: 0.3,
          rootMargin: "-20% 0px -55% 0px",
        },
      );

      sections.forEach((section) => intersectionObserver?.observe(section));
    }

    function cleanup() {
      intersectionObserver?.disconnect();
      intersectionObserver = null;
    }

    safeInitTOC();

    document.addEventListener("astro:page-load", safeInitTOC);
    document.addEventListener("astro:before-swap", cleanup);
  </script>
</BaseLayout> 